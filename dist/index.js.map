{"version":3,"file":"index.js","sources":["../src/AuthContext.tsx","../src/AuthProvider.tsx","../src/pkce.ts","../src/util.ts","../src/AuthService.ts"],"sourcesContent":["import React, { useContext, ReactElement } from 'react'\n\nimport { AuthServiceProps, AuthService } from './AuthService'\n\nexport type AuthContextProps = {\n  authService: AuthService\n}\n\nexport type AuthContextType = AuthContextProps | undefined\n\nexport const AuthContext = React.createContext<AuthContextProps | undefined>(\n  undefined\n)\n\nexport const useAuth = (): AuthContextProps => {\n  const context = useContext(AuthContext)\n  if (context === undefined) {\n    throw new Error('useAuth must be used within a AuthProvider')\n  }\n  return context\n}\n\nexport function withAuth<T>(\n  ComponentToWrap: React.ComponentType<T & AuthServiceProps>\n): React.FC<T & AuthServiceProps> {\n  const WrappedComponent = (props: T & AuthServiceProps): ReactElement => {\n    const authProps = useAuth()\n    return <ComponentToWrap {...authProps} {...props} />\n  }\n  WrappedComponent.displayName =\n    'withAuth_' + (ComponentToWrap.displayName || ComponentToWrap.name)\n  return WrappedComponent\n}\n","import React, { ReactElement, ReactNode } from 'react'\n\nimport { AuthService } from './AuthService'\nimport { AuthContext } from './AuthContext'\n\ninterface AuthProviderProps {\n  children: ReactNode\n  authService: AuthService\n}\n\nexport const AuthProvider = (props: AuthProviderProps): ReactElement => {\n  const { authService, children } = props\n\n  return (\n    <AuthContext.Provider value={{ authService }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n","import { randomBytes, createHash } from 'crypto'\n\nexport type PKCECodePair = {\n  codeVerifier: string\n  codeChallenge: string\n  createdAt: Date\n}\n\nexport const base64URLEncode = (str: Buffer): string => {\n  return str\n    .toString('base64')\n    .replace(/\\+/g, '-')\n    .replace(/\\//g, '_')\n    .replace(/=/g, '')\n}\n\nexport const sha256 = (buffer: Buffer): Buffer => {\n  return createHash('sha256').update(buffer).digest()\n}\n\nexport const createPKCECodes = (): PKCECodePair => {\n  const codeVerifier = base64URLEncode(randomBytes(64))\n  const codeChallenge = base64URLEncode(sha256(Buffer.from(codeVerifier)))\n  const createdAt = new Date()\n  const codePair = {\n    codeVerifier,\n    codeChallenge,\n    createdAt\n  }\n  return codePair\n}\n","export const toSnakeCase = (str: string): string => {\n  return str\n    .split(/(?=[A-Z])/)\n    .join('_')\n    .toLowerCase()\n}\n\nexport const toUrlEncoded = (obj: {}): string => {\n  return Object.keys(obj)\n    .map(\n      (k) =>\n        encodeURIComponent(toSnakeCase(k)) + '=' + encodeURIComponent(obj[k])\n    )\n    .join('&')\n}\n","/* eslint-disable @typescript-eslint/camelcase */\nimport { createPKCECodes, PKCECodePair } from './pkce'\nimport { toUrlEncoded } from './util'\n\nimport jwtDecode from 'jwt-decode'\n\nexport interface AuthServiceProps {\n  clientId: string\n  clientSecret?: string\n  contentType?: string\n  location: Location\n  provider: string\n  redirectUri?: string\n  scopes: string[]\n  autoRefresh?: boolean\n  refreshSlack?: number\n  locale?: string\n}\n\nexport interface AuthTokens {\n  id_token: string\n  access_token: string\n  refresh_token: string\n  expires_in: number\n  expires_at?: number // calculated on login\n  token_type: string\n}\n\nexport interface JWTIDToken {\n  given_name: string\n  family_name: string\n  name: string\n  email: string\n}\n\nexport interface TokenRequestBody {\n  clientId: string\n  grantType: string\n  redirectUri?: string\n  refresh_token?: string\n  clientSecret?: string\n  code?: string\n  codeVerifier?: string\n}\n\nexport class AuthService<TIDToken = JWTIDToken> {\n  props: AuthServiceProps\n  timeout?: number\n\n  constructor(props: AuthServiceProps) {\n    this.props = props\n    const code = this.getCodeFromLocation(window.location)\n    if (code !== null) {\n      try {\n        this.getPkce() // check if pkce exists before fetching token\n        this.fetchToken(code)\n        .then(() => {\n          this.restoreUri()\n        })\n      } catch (e) {\n        this.removeItem('pkce')\n          this.removeItem('auth')\n          this.removeCodeFromLocation()\n          console.warn({ e })\n      }\n    } else if (this.props.autoRefresh) {\n      this.startTimer()\n    }\n  }\n\n  getUser(): {} {\n    const t = this.getAuthTokens()\n    if (null === t) return {}\n    const decoded = jwtDecode(t.id_token) as TIDToken\n    return decoded\n  }\n\n  getCodeFromLocation(location: Location): string | null {\n    const split = location.toString().split('?')\n    if (split.length < 2) {\n      return null\n    }\n    const pairs = split[1].split('&')\n    for (const pair of pairs) {\n      const [key, value] = pair.split('=')\n      if (key === 'code') {\n        return decodeURIComponent(value || '')\n      }\n    }\n    return null\n  }\n\n  removeCodeFromLocation(): void {\n    const [base, search] = window.location.href.split('?')\n    if (!search) {\n      return\n    }\n    const newSearch = search\n      .split('&')\n      .map((param) => param.split('='))\n      .filter(([key]) => key !== 'code')\n      .map((keyAndVal) => keyAndVal.join('='))\n      .join('&')\n    window.history.replaceState(\n      window.history.state,\n      'null',\n      base + (newSearch.length ? `?${newSearch}` : '')\n    )\n  }\n\n  getItem(key: string): string | null {\n    return window.localStorage.getItem(key)\n  }\n  removeItem(key: string): void {\n    window.localStorage.removeItem(key)\n  }\n\n  getPkce(): PKCECodePair {\n    const pkce = window.localStorage.getItem('pkce')\n    if (null === pkce) {\n      throw new Error('PKCE pair not found in local storage')\n    } else {\n      return JSON.parse(pkce)\n    }\n  }\n\n  setAuthTokens(auth: AuthTokens): void {\n    const { refreshSlack = 5 } = this.props\n    const now = new Date().getTime()\n    auth.expires_at = now + (auth.expires_in + refreshSlack) * 1000\n    window.localStorage.setItem('auth', JSON.stringify(auth))\n  }\n\n  getAuthTokens(): AuthTokens {\n    return JSON.parse(window.localStorage.getItem('auth') || '{}')\n  }\n\n  isPending(): boolean {\n    return (\n      window.localStorage.getItem('pkce') !== null &&\n      window.localStorage.getItem('auth') === null\n    )\n  }\n\n  isAuthenticated(): boolean {\n    return window.localStorage.getItem('auth') !== null\n  }\n\n  async logout(): Promise<boolean> {\n    this.removeItem('pkce')\n    this.removeItem('auth')\n    window.location.reload()\n    return true\n  }\n\n  async login(): Promise<void> {\n    this.authorize()\n  }\n\n  // this will do a full page reload and to to the OAuth2 provider's login page and then redirect back to redirectUri\n  authorize(): boolean {\n    const { clientId, provider, redirectUri, scopes, locale } = this.props\n\n    const pkce = createPKCECodes()\n    window.localStorage.setItem('pkce', JSON.stringify(pkce))\n    window.localStorage.setItem('preAuthUri', location.href)\n    window.localStorage.removeItem('auth')\n    const codeChallenge = pkce.codeChallenge\n\n    const query = {\n      clientId,\n      scope: scopes.join(' '),\n      responseType: 'code',\n      redirectUri,\n      codeChallenge,\n      codeChallengeMethod: 'S256',\n      locale\n    }\n    // Responds with a 302 redirect\n    const url = `${provider}/authorize?${toUrlEncoded(query)}`\n    window.location.replace(url)\n    return true\n  }\n\n  // this happens after a full page reload. Read the code from localstorage\n  async fetchToken(code: string, isRefresh = false): Promise<AuthTokens> {\n    const {\n      clientId,\n      clientSecret,\n      contentType,\n      provider,\n      redirectUri,\n      autoRefresh = true\n    } = this.props\n    const grantType = 'authorization_code'\n\n    let payload: TokenRequestBody = {\n      clientId,\n      ...(clientSecret ? { clientSecret } : {}),\n      redirectUri,\n      grantType\n    }\n    if (isRefresh) {\n      payload = {\n        ...payload,\n        grantType: 'refresh_token',\n        refresh_token: code\n      }\n    } else {\n      const pkce: PKCECodePair = this.getPkce()\n      const codeVerifier = pkce.codeVerifier\n      payload = {\n        ...payload,\n        code,\n        codeVerifier\n      }\n    }\n\n    const response = await fetch(`${provider}/token`, {\n      headers: {\n        'Content-Type': contentType || 'application/x-www-form-urlencoded'\n      },\n      method: 'POST',\n      body: toUrlEncoded(payload)\n    })\n    this.removeItem('pkce')\n    let json = await response.json()\n    if (isRefresh && !json.refresh_token) {\n      json.refresh_token = payload.refresh_token\n    }\n    this.setAuthTokens(json as AuthTokens)\n    if (autoRefresh) {\n      this.startTimer()\n    }\n    return this.getAuthTokens()\n  }\n\n  armRefreshTimer(refreshToken: string, timeoutDuration: number): void {\n    if (this.timeout) {\n      clearTimeout(this.timeout)\n    }\n    this.timeout = window.setTimeout(() => {\n      this.fetchToken(refreshToken, true)\n        .then(({ refresh_token: newRefreshToken, expires_at: expiresAt }) => {\n          if (!expiresAt) return\n          const now = new Date().getTime()\n          const timeout = expiresAt - now\n          if (timeout > 0) {\n            this.armRefreshTimer(newRefreshToken, timeout)\n          } else {\n            this.removeItem('auth')\n            this.removeCodeFromLocation()\n          }\n        })\n        .catch((e) => {\n          this.removeItem('auth')\n          this.removeCodeFromLocation()\n          console.warn({ e })\n        })\n    }, timeoutDuration)\n  }\n\n  startTimer(): void {\n    const authTokens = this.getAuthTokens()\n    if (!authTokens) {\n      return\n    }\n    const { refresh_token: refreshToken, expires_at: expiresAt } = authTokens\n    if (!expiresAt || !refreshToken) {\n      return\n    }\n    const now = new Date().getTime()\n    const timeout = expiresAt - now\n    if (timeout > 0) {\n      this.armRefreshTimer(refreshToken, timeout)\n    } else {\n      this.removeItem('auth')\n      this.removeCodeFromLocation()\n    }\n  }\n\n  restoreUri(): void {\n    const uri = window.localStorage.getItem('preAuthUri')\n    window.localStorage.removeItem('preAuthUri')\n    console.log({ uri })\n    if (uri !== null) {\n      window.location.replace(uri)\n    }\n    this.removeCodeFromLocation()\n  }\n}\n"],"names":["AuthContext","React","createContext","undefined","useAuth","context","useContext","Error","withAuth","ComponentToWrap","WrappedComponent","props","authProps","displayName","name","AuthProvider","authService","children","Provider","value","base64URLEncode","str","toString","replace","sha256","buffer","createHash","update","digest","createPKCECodes","codeVerifier","randomBytes","codeChallenge","Buffer","from","createdAt","Date","codePair","toSnakeCase","split","join","toLowerCase","toUrlEncoded","obj","Object","keys","map","k","encodeURIComponent","AuthService","code","getCodeFromLocation","window","location","getPkce","fetchToken","then","restoreUri","e","removeItem","removeCodeFromLocation","console","warn","autoRefresh","startTimer","getUser","t","getAuthTokens","decoded","jwtDecode","id_token","length","pairs","pair","key","decodeURIComponent","href","base","search","newSearch","param","filter","keyAndVal","history","replaceState","state","getItem","localStorage","pkce","JSON","parse","setAuthTokens","auth","refreshSlack","now","getTime","expires_at","expires_in","setItem","stringify","isPending","isAuthenticated","logout","reload","login","authorize","clientId","provider","redirectUri","scopes","locale","query","scope","responseType","codeChallengeMethod","url","isRefresh","clientSecret","contentType","grantType","payload","refresh_token","fetch","headers","method","body","response","json","armRefreshTimer","refreshToken","timeoutDuration","timeout","clearTimeout","setTimeout","newRefreshToken","expiresAt","authTokens","uri","log"],"mappings":"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"}